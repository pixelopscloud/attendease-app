name: AttendEase CI/CD Pipeline

on:
  push:
    branches:
      - main
      - dev

jobs:
  sonarcloud:
    name: SonarCloud Analysis
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: SonarCloud Scan
        run: |
          sonar-scanner \
            -Dsonar.organization=${{ secrets.SONAR_ORG }} \
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }} \
            -Dsonar.sources=. \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.token=${{ secrets.SONAR_TOKEN }}
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  build-and-push:
    name: Build & Push Images
    runs-on: self-hosted
    needs: sonarcloud
    outputs:
      image_tag: ${{ steps.tag.outputs.tag }}
    steps:
      - uses: actions/checkout@v3

      - name: Set Image Tag
        id: tag
        run: echo "tag=${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Docker Login
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Build & Push Backend
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/attendease-backend:${{ steps.tag.outputs.tag }} ./backend
          docker push ${{ secrets.DOCKER_USERNAME }}/attendease-backend:${{ steps.tag.outputs.tag }}

      - name: Build & Push Frontend
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/attendease-frontend:${{ steps.tag.outputs.tag }} ./frontend
          docker push ${{ secrets.DOCKER_USERNAME }}/attendease-frontend:${{ steps.tag.outputs.tag }}

  trivy-scan:
    name: Trivy Image Scan
    runs-on: self-hosted
    needs: build-and-push
    steps:
      - name: Scan Backend Image
        run: |
          trivy image --exit-code 0 --severity HIGH,CRITICAL \
          ${{ secrets.DOCKER_USERNAME }}/attendease-backend:${{ needs.build-and-push.outputs.image_tag }}

      - name: Scan Frontend Image
        run: |
          trivy image --exit-code 0 --severity HIGH,CRITICAL \
          ${{ secrets.DOCKER_USERNAME }}/attendease-frontend:${{ needs.build-and-push.outputs.image_tag }}

  update-infra:
    name: Update Infra Repo
    runs-on: self-hosted
    needs: [build-and-push, trivy-scan]
    steps:
      - name: Checkout Infra Repo
        uses: actions/checkout@v3
        with:
          repository: pixelopscloud/attendease-infra
          token: ${{ secrets.INFRA_REPO_TOKEN }}
          path: infra

      - name: Update Image Tags
        run: |
          TAG=${{ needs.build-and-push.outputs.image_tag }}
          ENV=${{ github.ref_name == 'main' && 'prod' || 'dev' }}
          sed -i "s|pixelopscloud/attendease-backend:.*|pixelopscloud/attendease-backend:$TAG|g" infra/$ENV/backend/deployment.yaml
          sed -i "s|pixelopscloud/attendease-frontend:.*|pixelopscloud/attendease-frontend:$TAG|g" infra/$ENV/frontend/deployment.yaml

      - name: Commit & Push
        run: |
          cd infra
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"
          git add .
          git commit -m "ci: update image tag to ${{ needs.build-and-push.outputs.image_tag }}"
          git push
